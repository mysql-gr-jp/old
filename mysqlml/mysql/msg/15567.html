<html>
<head>
<meta http-equiv="Content-Style-Type" context="text/css">
<title>mysql:15567</title>
<link rel=stylesheet type="text/css" href="../../../css/w3ml.css">
</head>
<body>
<p class="button"><a href="15566.html">[前]</a><a href="15568.html">[次]</a><a href="../list/15501-15600.html">[番号順一覧]</a><a href="../thread/15501-15600.html">[スレッド一覧]</a></p>
<p class="id">
mysql:15567
</p>
<div class="header">
<p>
From: ram &lt;ram &lt;ram@xxxxxxxxxx&gt;&gt;<br>
Date: Wed, 13 Apr 2011 16:25:55 +0900<br>
Subject: [mysql 15567] 列数が増えるとクロス集計ができない<br>

</p>
</div>
<div class="body">
<pre>
MYSQL初心者です。はじめまして。
MYSQLの書き方について、お知恵を拝借できればありがたいです。
（誤ってFree MLのほうに送ってしまい、再送させて頂きます。）

◆実行環境
MYSQL5.1.41　Windows2003/R3
◆現象
年月日の入ったレコードから日付別のレコード件数を抽出する、いわゆるクロス
集計のSQLを実行しようとしたところ、列数が増えてくると、動きがおかしくな
るような現象が出ています。
対象テーブル　TBL
日付　npdate char(8) yyyymmddの形式で数字が入る
コード１　tkcd char(5)
コード２　tksc char(4)
名称３　tknm char(40)
phpで以下のようなSQLを作成しています。
$sql=&quot;select a.tkcd,a.tksc,a.tknm,&quot;;
$sql.=&quot;sum(case when a.mm='01' then 1 else 0 end) '01',&quot;;
$sql.=&quot;sum(case when a.mm='02' then 1 else 0 end) '02',&quot;;
$sql.=&quot;sum(case when a.mm='03' then 1 else 0 end) '03',&quot;;
$sql.=&quot;sum(case when a.mm='04' then 1 else 0 end) '04',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '05',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '06',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '07',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '08',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '09',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '10',&quot;;
$sql.=&quot;sum(case when a.mm='05' then 1 else 0 end) '11',&quot;;
（以下略 '31'まで）
$sql.=&quot;from (select tkcd,tksc,tknm,substr(npdate,7,2) as mm from TBL &quot;;
$sql.=&quot;where tknm &lt;&gt; '' and npdate &gt;= '20110101' and npdate &lt;=
'20110131') as a &quot;;
$sql.=&quot;group by a.tkcd,a.tksc,a.tknm&quot;;

下記の例でいうと、列名が01〜09あたりまでは、正確に件数がカウントされた列
が作成されるのですが、列名10は列自体がカウントされず、また列数を少なくし
て10までにすると、列名10が作成されず、定義もしていない列11ができたりする
現象がおきています。

列数の制約としてもたかだか20も超えない程度ですし、データベース自体のテー
ブル数も5つほどしかありません。

最初はsubstrを直接case文の中に書いたり、sumをcountに変えたり、列名の前に
asを付けてみたりしましたが結果は同じです。

書き方に誤りがあるのか、もしくは、他にクロス集計の方法がありましたら、ご
教授頂けたら幸いです。

初穂太郎


</pre>
</div>
<p class="button"><a href="15566.html">[前]</a><a href="15568.html">[次]</a><a href="../list/15501-15600.html">[番号順一覧]</a><a href="../thread/15501-15600.html">[スレッド一覧]</a></p>
</body>
</html>
