<html><body><div style="color:; background-color:; font-family:MS PGothic, sans-serif;font-size:12pt"><div>明智重蔵です。<br><br>SQLの間違い集2 MySQLのユーザ変数は評価順序が未定義 - Qiita<br>http://qiita.com/AketiJyuuzou/items/cced9b70cc714b382d98<br>で私が書いた記事に関して、質問があります。<br><br>■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■<br>質問1<br>下記のRow_Number関数(ソートキーなし)と同じ結果を取得する<br>ユーザ変数を使ったSQLは結果が保証されますか？<br><br>結果を保証するというのは、どのような実行計画と最適化の組み合わせでも、<br>期待した結果(分析関数のRow_Number関数と同じ結果)を返し、<br>期待した結果を返さなかったら、MySQLのバグだと言えることを意味してます。<br><br>create table
 IDTable(<br>ID int,<br>primary key(ID));<br><br>insert into IDTable values (1),(3),(5),(10),(20);<br><br>-- Row_Number関数(ソートキーなし)を使ったSQL (MySQL8.0から多分動きます)<br>select Row_Number() over() from IDTable<br><br>-- ユーザ変数を使った上記と同じ結果を取得したいSQL<br>select @rn := @rn+1 from IDTable, (select @rn := 0)<br><br>上記のユーザ変数を使ったSQLは、<br>5.6マニュアル(日本語)の<br>https://dev.mysql.com/doc/refman/5.6/ja/user-variables.html<br><br>&gt;一般的なルールとして、SET ステートメント以外では、同じステートメント内で、<br>&gt;ユーザー変数に値を割り当ててその値を読み取ることは決してしないでください。<br>&gt;SELECT
 などのほかのステートメントでは、予想した結果が得られることもありますが、これは保証されません。<br><br>という記述に該当して、結果が保証されないと思いますが、<br>MySQLエキスパートの皆様は、どう考えますでしょうか？<br><br>私は、@rn := 0が、(1回目の@rn := @rn+1)の後で評価される可能性や、<br>2行以上の@rn :=
 @rn+1がパラレル評価されて、連番が重複する可能性があると思います。<br><br>■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■<br>質問2<br><br>MySQLの公式資料で、上記のようなユーザ変数の使い方をしたSQLに対して、<br>マニュアルのちょい書きではなく、下記の7点セットを揃えて、<br>これは結果を保証しないSQL文だと明示してるような公式資料はありますか？<br>1番 Create Table文<br>2番 Insert文<br>3番 Select文<br>4番 3番のSelect文で期待する結果<br>5番 3番のSelect文で期待するユーザ変数の評価順序<br>6番 3番のSelect文で結果としてありうる期待しない結果<br>7番
 6番のSelect文でのユーザ変数の評価順序<br><br>このような公式資料がないのであれば、作ってほしいと思います。<br></div></div></body></html>
