
<div class="moz-text-plain" style="font-family: -moz-fixed; font-size: 16px;" lang="ja"><pre>こんにちは。<br>ミヤタと申します。<br></pre><blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>From: Takayuki Okada <a class="moz-txt-link-rfc2396E" href="mailto:okada.takayuki@pfu.fujitsu.com">&lt;okada.takayuki@pfu.fujitsu.com&gt;</a><br>
<span class="moz-txt-citetags">&gt; </span>To: <a class="moz-txt-link-abbreviated" href="mailto:ml@mysql.gr.jp">ml@mysql.gr.jp</a><br><span class="moz-txt-citetags">&gt; </span>Subject: [mysql 15008] 検索処理を早くするには？<br><span class="moz-txt-citetags">&gt; </span>Date: 2009/09/03 20:35<br>
<span class="moz-txt-citetags">&gt; </span><br><span class="moz-txt-citetags">&gt; </span>全件検索が非常に遅くなりました。<br></pre></blockquote><pre><br>「全件検索」というのは、必ず全ての行をチェックするような処理という<br>事でしょうか（例えば select avg(col) from table; ）。<br>これが必須という事であれば、全テーブルまたは索引がメモリに載るように<br>
innodb_buffer_pool_size をかなり大きく保つ必要があります。<br>少ない件数からデータの追加と全件検索の実行で確認していけば、どの段階で<br>メモリとデータのバランスが崩れたのかが分かります。<br><br>※全テーブルと全索引を全件検索するようなSQLを1セットとして、最低、<br>　それを2回実行する必要があります。1回目はメモリに載せる用、2回目は<br>　メモリに載った状態での検索用。<br><br></pre>
<blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>explainで確認すると、一応、PKは使用しているようですが、<br><span class="moz-txt-citetags">&gt; </span>件数が多くなると、やはり遅くなります。<br></pre></blockquote><pre><br>explainの結果とご説明をお願いします。<br>
<br>普通、「全件検索」にPKと索引は必要ありません。<br>「全件検索」に必要なカラムが索引に全て含まれる場合、テーブルのデータ<br>ではなく索引だけを使用してSQLを実行する事ができるので、その場合には<br>索引は有用です。<br><br>MySQLのPKはクラスターインデックスなので、例えば複合インデックスのPKで<br>全件検索は、テーブルデータ本体のカラムだけを指定した全件検索と変わり<br>ないかもしれません。<br><br>
</pre><blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>インデックスは条件句が複数となるため、<br><span class="moz-txt-citetags">&gt; </span>それごとに作成したくはないと思ってますので、<br></pre></blockquote><pre><br>条件が複数であれば、それごとに要件を満たす索引が必要です。<br>
下記のインデックス結合が要件を満たすのであれば、その限りではない場合も<br>ありますので確認してみて下さい。<br><a class="moz-txt-link-freetext" href="http://dev.mysql.com/doc/refman/5.1/ja/index-merge-optimization.html">http://dev.mysql.com/doc/refman/5.1/ja/index-merge-optimization.html</a><br>
<br></pre><blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>From: Takayuki Okada <a class="moz-txt-link-rfc2396E" href="mailto:okada.takayuki@pfu.fujitsu.com">&lt;okada.takayuki@pfu.fujitsu.com&gt;</a><br>
<span class="moz-txt-citetags">&gt; </span>To: <a class="moz-txt-link-abbreviated" href="mailto:ml@mysql.gr.jp">ml@mysql.gr.jp</a><br><span class="moz-txt-citetags">&gt; </span>Subject: [mysql 15012] Re: 検索処理を早くするには？<br><span class="moz-txt-citetags">&gt; </span>Date: 2009/09/06 17:14<br>
<span class="moz-txt-citetags">&gt; </span><br><span class="moz-txt-citetags">&gt; </span>本件ですが、発行されうるselectの条件句の上位６つほどの<br><span class="moz-txt-citetags">&gt; </span>インデックスを作成しましたが、この影響として、<br><span class="moz-txt-citetags">&gt; </span>登録＆更新処理が非常に遅くなり、とても対策には使えませんでした。<br>
</pre></blockquote><pre><br>どのような更新クエリがどの程度の頻度で実行され、どの位の更新時間が<br>どの位に遅くなったのかをお教え下さい。<br><br></pre><blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>CPUがすかすかなので、もっと並列で仕事をさせるような<br><span class="moz-txt-citetags">&gt; </span>ことはできないものでしょうか？<br>
<span class="moz-txt-citetags">&gt; </span>また、show statusの結果も、いたって、悪い箇所は見当たりません。<br></pre></blockquote><pre><br>どの項目がどのように適切であると確認したのかを全てお教え下さい。<br><br></pre><blockquote type="cite"><pre><span class="moz-txt-citetags">&gt; </span>ちなみに、select文には副問い合わせもなく、とても<br>
<span class="moz-txt-citetags">&gt; </span>シンプルなものです。<br><span class="moz-txt-citetags">&gt; </span>件数が増えると、とても遅くなります。<br></pre></blockquote><pre><br>件数とは、全データ件数ですか？走査件数ですか？検索結果件数ですか？<br><br>失礼ですが、現状の情報では何も伺っていないのと同じような状況です。<br>
また岡田様がどの程度MySQLやデータベースに対して理解があるのかも<br>わからないため、まずは下記のような情報を出せるだけ出して頂くのが<br>良いと思います。<br><br>・サーバの構成（ハードウェア、OS（カーネル））<br>・my.cnf の内容<br>・SQL の内容（テーブル作成、索引作成、検索クエリ）<br>・explainの結果と説明<br>・データ件数<br>・サーバのメモリ使用状況<br>・my.cnf 設定の適切さをどのように確認したか（設定値とステータス）<br>
・どのような情報をもとに、どのようなチューニングを行ったか<br></pre></div>
